<!DOCTYPE html> <html> <head> <meta charset=utf-8> <meta content="IE=edge,chrome=1" http-equiv=X-UA-Compatible> <title>neosnippetとsmartinputで&lt;CR&gt;キーのマッピングを共存させる - かなりすごいブログ</title><link href="/stylesheets/theme-22018243.css" media=screen rel=stylesheet /> <link href="/stylesheets/monokai-a37e9352.css" media=screen rel=stylesheet /> </head> <body role=main> <header> <h1> <a href="/">かなりすごいブログ</a> </h1> </header> <div id=main><div class=entry> <div class=entry-header> <h1> neosnippetとsmartinputで&lt;CR&gt;キーのマッピングを共存させる </h1> <div class=entry-tags> <li class="default label"> <i class=icon-tag></i><a href="/tags/vim.html">Vim</a> </li> </div> </div> <div class=entry-share> <div class="share hatena"> <a href="//b.hatena.ne.jp/entry/" class=hatena-bookmark-button data-hatena-bookmark-layout=vertical-balloon data-hatena-bookmark-lang=ja title="このエントリーをはてなブックマークに追加"><img src="//b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width=20 height=20 style="border: none;"></a> <script src="//b.st-hatena.com/js/bookmark_button.js" charset=utf-8 async=async></script> </div> <div class="share twitter"> <a href="https://twitter.com/share" class=twitter-share-button data-count=vertical data-via=supermomonga data-lang=ja data-dnt=true>ツイート</a> </div> <div class="share facebook"> <div class=fb-like data-layout=box_count data-action=like data-show-faces=false data-share=false></div> </div> <div class="share pocket"> <a data-pocket-label=pocket data-pocket-count=vertical class=pocket-btn data-lang=en></a> </div> </div> <div class=entry-body><p><a href="//atnd.org/events/33746">Vim Advent Calendar 2012</a>、355日目の記事になります。</p> <h2 id=toc_0><code>&lt;cr&gt;</code>のマッピングについて</h2> <p>本日は、<code>&lt;CR&gt;</code>のマッピングを複数のプラグイン間で共有する設定について記事にしたいと思います。</p> <p>例として、<a href="https://github.com/Shougo/neosnippet.vim">neosnippet</a>及び<a href="https://github.com/Shougo/neocomplete.vim">neocomplete</a>と<a href="https://github.com/kana/vim-smartinput/">smartinput</a>及び<a href="https://github.com/cohama/vim-smartinput-endwise/">smartinput-endwise</a>の設定を共存させる方法をお伝えします。</p> <h2 id=toc_1>行いたい動作</h2> <p>まず、私は<code>neocomplete</code>で<code>neosnippet</code>の候補を補完し、さらに候補にフォーカスが当たっている状態で<code>&lt;CR&gt;</code>を押下することにより、スニペットを展開したいと考えています。</p> <p>更に、補完ポップアップメニューが表示されていない状態で<code>&lt;CR&gt;</code>を押下した際には、<code>smartinput-endwise</code>により、関数定義の閉じendなどを文脈から判断じて自動挿入したいと思います。</p> <h2 id=toc_2>設定</h2> <p>前提として、以下のプラグインを<a href="https://github.com/Shougo/neobundle.vim">neobundle</a>で管理しているものとします。</p> <ul> <li> <a href="https://github.com/Shougo/neocomplete.vim">neocomplete</a></li> <li> <a href="https://github.com/Shougo/neosnippet.vim">neosnippet</a></li> <li> <a href="https://github.com/kana/vim-smartinput/">smartinput</a></li> <li> <a href="https://github.com/cohama/vim-smartinput-endwise/">smartinput-endwise</a></li> </ul> <pre lang=vim>if neobundle#tap('vim-smartinput')
  call neobundle#config({
        \   'autoload' : {
        \     'insert' : 1
        \   }
        \ })

  function! neobundle#tapped.hooks.on_post_source(bundle)
    call smartinput_endwise#define_default_rules()
  endfunction

  call neobundle#untap()
endif

if neobundle#tap('vim-smartinput-endwise')
  function! neobundle#tapped.hooks.on_post_source(bundle)
    " neosnippet and neocomplete compatible
    call smartinput#map_to_trigger('i', '&lt;Plug>(vimrc_cr)', '&lt;Enter>', '&lt;Enter>')
    imap &lt;expr>&lt;CR> !pumvisible() ? "\&lt;Plug>(vimrc_cr)" :
          \ neosnippet#expandable() ? "\&lt;Plug>(neosnippet_expand)" :
          \ neocomplete#close_popup()
  endfunction
  call neobundle#untap()
endif

</pre> <p><code>smartinput_endwise#define_default_rules()</code>を実行した時点で、<code>&lt;CR&gt;</code>のマップが<code>smartinput</code>によって上書きされてしまいます。ですので、<code>neobundle#tapped.hooks.on_post_source(bundle)</code>によって、その後に再度<code>&lt;CR&gt;</code>をオリジナルの設定でマッピングします。</p> <pre lang=vim>call smartinput#map_to_trigger('i', '&lt;Plug>(vimrc_cr)', '&lt;Enter>', '&lt;Enter>')
imap &lt;expr>&lt;CR> !pumvisible() ? "\&lt;Plug>(vimrc_cr)" :
      \ neosnippet#expandable() ? "\&lt;Plug>(neosnippet_expand)" :
      \ neocomplete#close_popup()
</pre> <p>こちらについて解説します。 まず、<code>smartinput#map_to_trigger</code>によって、<code>&lt;Plug&gt;(vimrc_cr)</code>が押下された時に<code>smartinput-endwise</code>が動作するように設定します。 次に<code>imap</code>によって<code>&lt;CR&gt;</code>のマッピングを上書きします。<code>imap &lt;expr&gt;&lt;CR&gt;</code>といった様に、<code>&lt;expr&gt;</code>を使うことでマップ内容に式を書くことができます。<code>&lt;CR&gt;</code>が押下されるたびに設定した式が評価されます。</p> <p>式の内容を見て行きましょう。まず、<code>!pumvisible()</code>は<code>pumvisible()</code>が偽である時、つまり補完ポップアップメニューが開いていない時を意味します。補完を行っていない時は<code>smartinput</code>に処理を渡したいので、先ほど設定した<code>&lt;Plug&gt;(vimrc_cr)</code>を呼び出しています。次に<code>pumvisible()</code>が真である場合ですが、ここで三項演算子がネストしています。こちらは、<code>neosnippet#expandable()</code>が真（現在選択されている補完候補が<code>neosnippet</code>のものであり、スニペットが展開できる状態）であればスニペットを展開し、そうでなければ補完ポップアップメニューを閉じるという式になっています。</p> <p>これにより、<code>&lt;CR&gt;</code>を押下した時の動作を、以下のように定義することができました。</p> <ul> <li> 分岐1：補完ポップアップメニューが表示されていれば分岐2へ、そうでなければ<code>smartinput</code>にて<code>&lt;CR&gt;</code>を押下時に呼び出される関数を呼び出す</li> <li> 分岐2：スニペット候補が展開されていればスニペットを展開し、そうでなければ補完ポップアップメニューを閉じる</li> </ul> <h2 id=toc_3>まとめ</h2> <p>かなりべんり（かなり）</p> </div> <div class=entry-author> <div class=avatar> <img src="/images/kokoro-chan-da2b7132.png"> </div> <div class=profile> <h3> supermomonga </h3> <p> かなりすごいことでゆうめい。したまちでしらぬものはいない。 </p> <a href="https://twitter.com/supermomonga" class=twitter-follow-button data-show-count=false data-lang=ja data-size=large data-dnt=true>@supermomongaさんをフォロー</a> </div> </div> <div class=entry-meta> <h3> コメント一覧ですよ </h3> <div class=hatena_bookmark_comments data-uri="http://blog.supermomonga.com/articles/vim/share-cr-map-with-multiple-plugins.html"></div> </div> </div> <aside> <h2> タグ一覧ですよ </h2> <ol> <li class="default label"> <i class=icon-tag></i><a href="/tags/emacs.html">Emacs</a>(5) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/java.html">Java</a>(4) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/jdee.html">JDEE</a>(5) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/swt.html">SWT</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/svn.html">svn</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/ubuntu.html">Ubuntu</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/facebook.html">facebook</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/windows.html">Windows</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/mac.html">Mac</a>(2) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/fx.html">FX</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/metatrader4.html">MetaTrader4</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/vim.html">Vim</a>(6) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/lingr.html">Lingr</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/neobundle.html">NeoBundle</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/minecraft.html">Minecraft</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/ruby.html">Ruby</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/thingspast.html">ThingsPast</a>(1) </li> </ol> </aside> </div> <script>
      var _gaq = _gaq || [];
      _gaq.push(["_setAccount", "UA-22136268-1"]);
      _gaq.push(["_trackPageview"]);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script> </body> </html> <div id=fb-root></div> <script src="/javascripts/bookmark_blogparts-b37aab8f.js" async=async defer=defer></script> <script>
  // twitter share button
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
  // pocket save button
  !function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");
  // Facebook like button
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/ja_JP/all.js#xfbml=1&appId=184200125074087";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>