<!DOCTYPE html> <html> <head> <meta charset=utf-8> <meta content="IE=edge,chrome=1" http-equiv=X-UA-Compatible> <title>Vimと対話せよ - かなりすごいブログ</title><link href="/stylesheets/theme-22018243.css" media=screen rel=stylesheet /> <link href="/stylesheets/monokai-a37e9352.css" media=screen rel=stylesheet /> </head> <body role=main> <header> <h1> <a href="/">かなりすごいブログ</a> </h1> </header> <div id=main><div class=entry> <div class=entry-header> <h1> Vimと対話せよ </h1> <div class=entry-tags> </div> </div> <div class=entry-share> <div class="share hatena"> <a href="//b.hatena.ne.jp/entry/" class=hatena-bookmark-button data-hatena-bookmark-layout=vertical-balloon data-hatena-bookmark-lang=ja title="このエントリーをはてなブックマークに追加"><img src="//b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width=20 height=20 style="border: none;"></a> <script src="//b.st-hatena.com/js/bookmark_button.js" charset=utf-8 async=async></script> </div> <div class="share twitter"> <a href="https://twitter.com/share" class=twitter-share-button data-count=vertical data-via=supermomonga data-lang=ja data-dnt=true>ツイート</a> </div> <div class="share facebook"> <div class=fb-like data-layout=box_count data-action=like data-show-faces=false data-share=false></div> </div> <div class="share pocket"> <a data-pocket-label=pocket data-pocket-count=vertical class=pocket-btn data-lang=en></a> </div> </div> <div class=entry-body><p><a href="//atnd.org/events/33746">Vim Advent Calendar 2012</a>、303日目の記事になります。</p> <p>何やら来月に<a href="//partake.in/events/55ef537f-07fb-4e36-8f27-666f7925a4d7">momonga.vim #2</a>というのが開催されるらしいですね。楽しみです（すごく）。</p> <h2 id=toc_0>Vimと対話せよ</h2> <p>はい、Vimに対する不満の一つに、cmdlineがありますね。例えばEvilの置換実装、あれみたいなことができなかったりします。</p> <blockquote> <p>EvilにあってVimにない機能もあります. たとえば, Evilでは置換の際にもパターンにマッチした部分をハイライトでき, さらに置換結果をバッファ内にプレビューできます. <img src="/images/uploads/2013-09-20130209160344-0ba4811f.gif" alt=20130209160344 width=430 height=121 class="alignnone size-full wp-image-872"/><br> 引用：<a href="//d.hatena.ne.jp/tarao/20130303/evil_intro#usage-vim">Evil: EmacsをVimのごとく使う &#8211; 導入編</a></p> </blockquote> <p>こういう点に関しては、Emacsが羨ましかったりしますね。擬似的にcmdlineのようなものを作ってウィンドウ分割でごまかすくらいしか実装方法が思いつきません。つらい。</p> <p>まぁそれはそれとして、cmdlineへの不満の一つとして、「もっと対話したい」というのもあります。そう、VimmerはもっとVimと対話したいのです。</p> <p>Vimのコマンドは、基本的に対話を考えていない様に見えます。たとえば未保存のバッファで<code>:q</code>を実行すると警告が出るのみで、ユーザはもう一度最初から打ち直し、<code>:q!</code>を実行する必要があります。これは非常に不便です。<code>:q</code>を実行したユーザがそのバッファを閉じたいと思っているのは明らかなので、「未保存だけど、どうする？強制的にqしちゃう？」とVimに聞いて欲しいですね。</p> <p>うん、こちらならなんとかなりそうです。というわけでなんとかしました（なんとか）。</p> <h3 id=toc_1>Vim script（かなり）</h3> <pre lang=vim>function! SelectInteractive(question, candidates) " \{\{\{
  try
    let a:candidates[0] = toupper(a:candidates[0])
    let l:select = 0
    while index(a:candidates, l:select, 0, 1) == -1
      let l:select = input(a:question . ' [' . join(a:candidates, '/') . '] ')
      if l:select == ''
        let l:select = a:candidates[0]
      endif
    endwhile
    return tolower(l:select)
  finally
    redraw!
  endtry
endfunction " \}\}\}

function! BufferWipeoutInteractive() " \{\{\{
  if &#038;modified == 1
    if SelectInteractive('Buffer is unsaved. Force quit?', ['n', 'y']) == 'y'
      bwipeout!
    endif
  else
    bwipeout
  endif
endfunction " \}\}\}

nnoremap &lt;c-x>k  :call BufferWipeoutInteractive()&lt;cr>

</pre> <p>はい、これで<code>&lt;C-x&gt;k</code>にて対話的なバッファ削除を実装できました。私はバッファを綺麗サッパリ消したい派なので<code>bwipeout</code>を使っていますが、そうじゃない人は<code>q</code>とかでいいでしょう。</p> <p>未保存のバッファを開いた状態でキーバインド<code>&lt;C-x&gt;k</code>を実行すると、「Buffer is unsaved. Force quit?」と質問されます。cmdlineでそのまま何も入力せずにEnterを押下すると、デフォルト選択肢（1つ目の選択肢）である<code>N</code>が選択されたとみなされ、バッファ削除がキャンセルされます。<code>y</code>を入力すると、<code>bwipeout!</code>が実行され、強制的にバッファが削除されます。</p> <p>いいかんじですね。でも、次のようにしたらもっとよさそうです。</p> <h3 id=toc_2>Vim script（ふたつめの）</h3> <pre lang=vim>function! SelectInteractive(question, candidates) " \{\{\{
  try
    let a:candidates[0] = toupper(a:candidates[0])
    let l:select = 0
    while index(a:candidates, l:select, 0, 1) == -1
      let l:select = input(a:question . ' [' . join(a:candidates, '/') . '] ')
      if l:select == ''
        let l:select = a:candidates[0]
      endif
    endwhile
    return tolower(l:select)
  finally
    redraw!
  endtry
endfunction " \}\}\}

function! BufferWipeoutInteractive() " \{\{\{
  if &#038;modified == 1
    let l:selected = SelectInteractive('Buffer is unsaved. What should I do?', ['n', 'w', 'q'])
    if l:selected == 'w'
      write
      bwipeout
    elseif l:selected == 'q'
      bwipeout!
    endif
  else
    bwipeout
  endif
endfunction " \}\}\}


nnoremap &lt;c-x>k  :call BufferWipeoutInteractive()&lt;cr>

</pre> <p>はい、これで、<code>N</code>もしくは未指定でキャンセル、<code>w</code>で書き込みを行ってから<code>bwipeout</code>、<code>q</code>で書き込みを行わずに<code>bwipeout!</code>が実行されるようになりました。とても便利ですね。</p> <h2 id=toc_3>まとめ</h2> <p>cmdlineを利用して、もっとVimと対話していきましょう！</p> </div> <div class=entry-author> <div class=avatar> <img src="/images/kokoro-chan-da2b7132.png"> </div> <div class=profile> <h3> supermomonga </h3> <p> かなりすごいことでゆうめい。したまちでしらぬものはいない。 </p> <a href="https://twitter.com/supermomonga" class=twitter-follow-button data-show-count=false data-lang=ja data-size=large data-dnt=true>@supermomongaさんをフォロー</a> </div> </div> <div class=entry-meta> <h3> コメント一覧ですよ </h3> <div class=hatena_bookmark_comments data-uri="http://blog.supermomonga.com/articles/vim/taiwa.html"></div> </div> </div> <aside> <h2> タグ一覧ですよ </h2> <ol> <li class="default label"> <i class=icon-tag></i><a href="/tags/emacs.html">Emacs</a>(5) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/java.html">Java</a>(4) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/jdee.html">JDEE</a>(5) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/swt.html">SWT</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/svn.html">svn</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/ubuntu.html">Ubuntu</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/facebook.html">facebook</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/windows.html">Windows</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/mac.html">Mac</a>(2) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/fx.html">FX</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/metatrader4.html">MetaTrader4</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/vim.html">Vim</a>(6) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/ruby.html">Ruby</a>(2) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/jruby.html">JRuby</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/javafx.html">JavaFX</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/lingr.html">Lingr</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/neobundle.html">NeoBundle</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/minecraft.html">Minecraft</a>(1) </li> <li class="default label"> <i class=icon-tag></i><a href="/tags/thingspast.html">ThingsPast</a>(1) </li> </ol> </aside> </div> <script>
      var _gaq = _gaq || [];
      _gaq.push(["_setAccount", "UA-22136268-1"]);
      _gaq.push(["_trackPageview"]);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script> </body> </html> <div id=fb-root></div> <script src="/javascripts/bookmark_blogparts-90b8ae42.js" async=async defer=defer></script> <script>
  // twitter share button
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
  // pocket save button
  !function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");
  // Facebook like button
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/ja_JP/all.js#xfbml=1&appId=184200125074087";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>